---
title: "publication_plots"
author: "Liyenne"
date: "2024-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(readxl)
require(purrr)
require(tibble)
require(tidyverse)

require(ggplot2)
require(ggpubr)
require(ggordiplots)
require(ggvegan)
require(ggsignif)
require(rstatix)

require(vegan)
```

# Main text
## Fig 2. grazing signs
### Fig 2a dung counts
```{r echo = FALSE}
dung_transect_data <- readr::read_csv('../../2_input/2_data_products/dung_data_transect_summary.csv')

dung_transect_data <- dung_transect_data %>% 
  mutate(country = as.factor(ifelse(grepl('N', transect), 'Storfjord', 'Malla'))) %>%
  dplyr::select(transect, country, everything())

dung_transect_data %>% head(10)
```

```{r echo = FALSE}
dung_transect_data$country <- factor(dung_transect_data$country, levels = c("Storfjord", "Malla"))

# create label information for significance 
sig <- distinct(dung_transect_data, section, country) %>% 
  arrange(section, country) 

sig$y = c(70, 0, 91, 0, 88, 0) # total count
#sig$y = c(39, 0, 45, 0, 44, 0) #frequency
sig$label = c("***", NA, "***", NA, "***", NA)


p1 <- dung_transect_data %>%
  ggplot(aes(section, total_dung, fill = country)) + 
  geom_boxplot(outlier.shape = NA) + 
  #geom_jitter(aes(), alpha = 0.3, position = position_jitterdodge(jitter.width = 0, dodge.width = 0.75)) +
  geom_text(data = sig, aes(y = y, label = label), 
                  position = position_dodge(width = 0)) +
  theme_classic() +
  labs(fill = "Reindeer density", x = "Habitat", y = "Dung count") +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High")) +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        #axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position =  "top"
        ); print(p1)


```

### Fig 2b numbers of root shoots
```{r include = FALSE}
tree_data <- readr::read_csv('../../3_output/1_data_products/tree_data.csv')
```

```{r include = FALSE}
tree_data$country <- factor(tree_data$country, levels = c("Storfjord", "Malla"))
tree_data$class <- factor(tree_data$class, levels = c("seedling", "sapling", "tree", "dead"))

# create label information for significance 
sig <- distinct(tree_data, country, class) %>% 
  arrange(class, country) %>% 
  filter(!class == "dead")

sig$y = c(4, 0, 7, 0, 14, 0)
sig$label = c("ns", NA, "*", NA, "***", NA)

p2 <- tree_data %>%
  na.omit() %>%
  ggplot(aes(class, n_stems, fill = country)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_text(data = sig, aes(y = y, label = label), 
                  position = position_dodge(width = 0)) +
#  geom_jitter(aes(), alpha = 0.3, position = #position_jitterdodge(jitter.width = 0.3, dodge.width = 0.75)) +
  ylim(1, 14) + 
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High"), guide = "none") +
  labs(x = "Size class", y = "Number of root shoots", fill = "Reindeer density") +
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1)); print(p2)
```

### Fig 2c leaf sections
```{r (down)load data}
#get_file(node = "3b2xy",
#         file = "tree_core_data_raw.xlsx",
#         path = "2_input/1_raw_data", 
#         remote_path = "raw_data") 

data_raw <- openxlsx::read.xlsx("../../2_input/1_raw_data/tree_core_data_raw.xlsx")
```

```{r}
data <- data_raw %>% 
  dplyr::select(!distance:n_stems) %>% 
  pivot_longer(!code, names_to = "section", values_to = "leaves")

data$section <- as.numeric(data$section)
data$leaves <- as.factor(data$leaves)

data <- data %>% 
  mutate(country = as.factor(ifelse(grepl('N', code), 'Storfjord', 'Malla'))) %>%
  dplyr::select(code, country, section, leaves)
```

```{r}
data$country <- factor(data$country, levels = c("Storfjord", "Malla"), labels = c( "Low reindeer density", "High reindeer density"))

p3 <- data %>%  
  filter(leaves == 1) %>% 
  #ggplot(aes(x = section)) +
  #geom_histogram() +
  gghistogram(x = "section", color = "country", fill = "country", bins = 21) +
  facet_grid(~ country) +
  scale_color_manual(values = c("#77BFBC", "#EB956A"), labels = c("High", "Low"), guide = "none") + 
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("High", "Low"), guide = "none") +
  labs(y = "Frequency of leaf presence", x = "Section of the trunk (10 cm)") + 
  theme_classic() +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1), 
        legend.position = "none") + 
  coord_flip(); print(p3)
```

```{r}
 ggarrange(p1, p3, p2,
          ncol = 3, 
          labels = c("a", "b", "c"), 
          widths = c(2.5, 4, 2.5), 
          common.legend = TRUE)

ggsave("../../3_output/2_graphs/publication_ready/Fig2_grazing_signs.svg", height = 4, width = 7.5)
```

## Fig 3. numbers of trees
```{r echo = FALSE}
tree_transect_data_full <- readr::read_csv('../../3_output/1_data_products/tree_transect_data_full.csv')
tree_transect_data_full %>% head(10)

tree_transect_data_full <- tree_transect_data_full %>% 
  left_join(transect_data, by = c("transect" = "transect", "country" = "country", "section" = "habitat"))
```

```{r boxplot of numbers of trees per class,echo = FALSE}
facet_order <- c("seedling", "sapling", "tree", "dead")
class_labs <- c("seedlings", "saplings", "trees", "dead trees")
names(class_labs) <- c("seedling", "sapling", "tree", "dead")

tree_transect_data_full$country <- factor(tree_transect_data_full$country, levels = c("Storfjord", "Malla"))

tree_transect_data_full$class <- factor(tree_transect_data_full$class, levels = c("seedling", "sapling", "tree", "dead"))

# create label information for significance 
sig <- distinct(tree_transect_data_full, class, section, country) %>%
  arrange(class, section, country) 

sig$y = c(13, 0, 11, 0, 3, 0, 38, 0, 22, 0, 10, 0, 50, 0, 9, 0, 5, 0, 6.5, 0, 2.5, 0, 0.5, 0)
sig$label = c("*", NA, "ns", NA, "ns", NA, "***", NA, "***", NA, "**", NA,"ns", NA, "ns", NA, "**", NA, "*", NA, "ns", NA, "ns", NA)

#sig$y = c(16, 0, 42, 0, 20, 0, 40, 0, 24, 0, 14, 0, 52, 0, 11, 0, 14, #0, 18, 0, 4, 0, 3, 0)
#sig$label = c("*", NA, "ns", NA, "ns", NA, "***", NA, "***", NA, #"**", NA,"ns", NA, "ns", NA, "**", NA, "*", NA, "ns", NA, "ns", NA)

p1 <- tree_transect_data_full %>%
  mutate(class = factor(class, levels = facet_order)) %>% 
  #filter(class != "dead" & class != "tree") %>%  
  ggplot(aes(section, n, fill = country)) + 
  geom_boxplot(outliers = FALSE) +
#  geom_jitter(aes(), alpha = 0.3, position = #position_jitterdodge(jitter.width = 0, dodge.width = 0.75)) + 
  geom_text(data = sig, aes(y = y, label = label), 
                  position = position_dodge(width = 0)) +
  theme_classic() +
  facet_wrap(~class, scales = "free", drop = TRUE, ncol = 4,
             labeller = labeller(class = class_labs)) + 
  labs(fill = "Reindeer density", x = "Habitat", y = "Count") +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High")) +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), legend.position = "top", 
        strip.background = element_rect(color = "black", size = 1),
        axis.text.x = element_text(angle = 45, hjust = 1)); print(p1)

ggsave("../../3_output/2_graphs/publication_ready/Fig3_tree_counts1.svg", height = 4, width = 4.5)
```

## Fig 4. vegetation 
**vegetation data**
```{r echo = FALSE}
vegetation_data <- readr::read_csv('../../2_input/1_raw_data/vegetation_data_raw.csv')

vegetation_data %>% head(10)
```
**dung count data**
```{r}
dung_data <- read.csv("../../3_output/1_data_products/dung_count_data.csv")

dung_data %>% 
  head(10)
```

**meta data**
```{r echo = FALSE}
meta_data <- readr::read_csv('../../2_input/1_raw_data/plot_data_extended.csv')
meta_data %>% head(10)

dnp <- readxl::read_excel("../../2_input/1_raw_data/chem/DNP.xlsx") %>% 
  dplyr::select(code, NO3, NH4, PO4_corrected)

soil_chem <- readr::read_csv("../../2_input/1_raw_data/chem/chem_malla_soil_leaves.csv") %>% 
  filter(type == "soil") %>% 
  dplyr::select(Sample_ID, wN, d15N, wC, d13C, CN_ratio) %>% 
  rename(code = Sample_ID)

meta_data <- meta_data %>% 
  left_join(dnp, by = "code") %>% 
  left_join(soil_chem, by = "code")
```

The code below appends the sum of scats found in the 10 meters closes to each plot to the meta data
```{r}
# add dung counts to vegetation_data
vegetation_data <- dung_data %>% 
  mutate(habitat = case_when(
    distance <= -41 ~ "forest", 
    distance >= -5 & distance <= 5 ~ "treeline", 
    distance >= 45 & distance <= 54 ~ "tundra",
    distance >= 91 ~ "upper_tundra"
  )) %>% 
  na.omit() %>% 
  group_by(transect, habitat) %>% 
  summarise(dung_count = sum(count)) %>% 
  inner_join(vegetation_data, ., by = join_by(transect, habitat)) %>% 
  dplyr::select(code:habitat, dung_count, everything())
  
```

```{r}
vegetation_data_l <- vegetation_data %>% 
  pivot_longer(salix:rock, names_to = "type", values_to = "cover")

vegetation_data_l %>% 
  head(10)

vegetation_data_l$country <- factor(vegetation_data_l$country, levels = c("N", "F"))

vegetation_data_l %>% 
  filter(type == c("salix", "gram")) %>% 
ggplot(aes(habitat, cover)) +
  geom_boxplot(aes(fill = country)) +
    labs(fill = "Grazing regime") +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ type) +
  theme_classic() +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("../../3_output/2_graphs/veg_covers.svg", height = 3.5, width = 5)
```


```{r}
vegetation_tbl <- vegetation_data %>% # add environmental variables
  full_join(meta_data) %>% 
  dplyr::select(code:habitat, dung_count, slope, aspect, twi, everything()) %>% 
  column_to_rownames("code") 

vegetation_tbl %>% 
  as.data.frame() %>% 
  head(10)

meta_data <- vegetation_tbl %>% # create meta data 
  mutate(country_habitat = paste0(country, habitat)) %>% 
  dplyr::select(country, habitat, country_habitat, dung_count, slope, aspect, twi, everything())
```
### NMDS
```{r include = FALSE}
# multivariate (NMDS)
  # scat counts around plots
  # slope
  # forest density (n trees)
  # aspect
  # soil data
  # ndvi?

veg_nmds <- vegetation_data %>% 
  select(code, salix:rock) %>% 
  column_to_rownames("code") %>% 
  metaMDS() %>% 
  scores(tidy = TRUE) %>%
  as_tibble(ronames = "code")
  
species_nmds <- veg_nmds %>% 
  filter(score == "species")

veg_nmds <- veg_nmds %>% 
  filter(score == "sites") %>% 
  select(NMDS1, NMDS2)
  
meta_nmds <- cbind(meta_data, veg_nmds)
``` 

```{r NMDS plot (country), echo = FALSE}
hull_data <- meta_nmds %>% # find convex hulls
  group_by(country) %>% # for each combination of country and habitat
  arrange(NMDS1, NMDS2) %>%
  slice(chull(NMDS1, NMDS2))

ggplot() + 
  geom_point(data = meta_nmds, aes(x = NMDS1, y = NMDS2, shape = habitat, colour = country),size=3) + # add the point markers
  geom_polygon(data=hull_data,aes(x=NMDS1,y=NMDS2, fill = country),alpha=0.30) +
  geom_text(data=species_nmds,aes(x=NMDS1,y=NMDS2,label=label),alpha=0.5) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
  theme_bw() +
  guides(color = guide_legend(override.aes = list(shape = NA)))
```

```{r NMDS plot (country and habitat), echo = FALSE}
hull_data <- meta_nmds %>% # find convex hulls
  group_by(country, habitat) %>% # for each combination of country and habitat
  arrange(NMDS1, NMDS2) %>%
  slice(chull(NMDS1, NMDS2))

ggplot() +
  scale_linetype_manual(values = c("forest" = "solid", "treeline" = "dashed", "tundra" = "dotdash", "upper_tundra" = "dashed")) +
  geom_point(data = meta_nmds, aes(x = NMDS1, y = NMDS2, shape = habitat, colour = country), size = 3) + # add the point markers 
  geom_polygon(data = hull_data, aes(x = NMDS1, y = NMDS2, color = country, fill = country, linetype = habitat), alpha = 0.30) +
  geom_text(data = species_nmds, aes(x = NMDS1, y = NMDS2, label = label), alpha = 0.5) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
  theme_bw() +
  guides(color = guide_legend(override.aes = list(shape = NA)))
```

```{r PEMANOVA}
adonis2(as.matrix(vegetation_data[, 7:18]) ~ country * habitat, vegetation_data, permu = 999, method = "bray")
```

Within group variation found among habitats (forest, treeline, tundra, upper tundra) in Norway and Finland does not differ. Meaning that the outcome of the PERMANOVA is likely reliable. 
```{r}
vegetation_tbl %>% 
  select(salix:rock) %>% 
  as.dist() %>% 
  betadisper(meta_data$country_habitat) %>% 
  permutest()
```

fitting environmental variables
```{r include=FALSE}
nmds <- vegetation_data %>% 
  select(code, salix:rock) %>% 
  column_to_rownames("code") %>% 
  metaMDS()
```


```{r }
ef <- meta_data %>% 
  select(dung_count, slope, aspect, twi, NO3, NH4, PO4_corrected, wN:CN_ratio, country, habitat, transect) %>% 
  envfit(nmds, ., na.rm = TRUE); ef
```

**NMDS with environmental variables**
```{r echo = FALSE}
ef_coord_cont <-  as.data.frame(scores(ef, "vectors")) * ordiArrowMul(ef) # map vectors in plot
ef_coord_cont <- ef_coord_cont[!(row.names(ef_coord_cont) %in% c("slope", "wN", "wC")),]

rownames(ef_coord_cont) <- c("dung", "aspect", "TWI", "nitrate", "ammonium", "phosphate", "dN15", "dC13", "C:N ratio") 

ef_coord_cat = as.data.frame(scores(ef, "factors")) * ordiArrowMul(ef) # map factors in plot
ef_coord_cat <- ef_coord_cat[1:6,]
rownames(ef_coord_cat) <- c("Finland", "Norway", "forest", "treeline", "tundra", "high tundra")

hull_data <- meta_nmds %>% # find convex hulls
  group_by(country) %>% # for each combination of country and habitat
  arrange(NMDS1, NMDS2) %>%
  slice(chull(NMDS1, NMDS2))

ggplot() + 
  geom_point(data = meta_nmds, aes(x = NMDS1, y = NMDS2, shape = habitat, colour = country),size=3) + # add the point markers
  scale_color_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) + 
  geom_polygon(data = hull_data, aes(x = NMDS1, y = NMDS2, fill = country, color = country),alpha=0.30) + 
  scale_fill_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) +
  geom_text(data=species_nmds,aes(x=NMDS1,y=NMDS2,label=label),alpha=0.5) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
       data = ef_coord_cont, linewidth =1, alpha = 0.5, colour = "grey30") +
     geom_point(data = ef_coord_cat, aes(x = NMDS1, y = NMDS2), 
       shape = "diamond", size = 4, alpha = 0.6, colour = "navy") +
     geom_text(data = ef_coord_cat, aes(x = NMDS1, y = NMDS2+0.08), 
       label = row.names(ef_coord_cat), colour = "navy", fontface = "bold") + 
     geom_text(data = ef_coord_cont, aes(x = NMDS1, y = NMDS2), colour = "grey30", 
       fontface = "bold", label = row.names(ef_coord_cont)) + 
  labs(fill = "Grazing regime", color = "Grazing regime", shape = "Habitat") +
  theme_classic() +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))

ggsave("../../3_output/2_graphs/veg_nmds.svg", height = 5, width = 6)
```

```{r}
gg_ordisurf(ord = nmds, env.var = meta_data$aspect, binwidth = 5)
```

### CCA
```{r include = FALSE}
x <-  meta_data %>% 
  dplyr::select(salix:rock) 
  
y <- meta_data %>% 
  dplyr::select(country, habitat, dung_count:twi, NO3:CN_ratio)
```

#### country controlling for habitat
```{r}
main_cca <- cca(x ~ country + Condition(habitat), y)
permutest(main_cca, permutations = how(nperm = 999))
```

```{r}
# get CCA scores ready for plotting
species_cca <- fortify(main_cca) %>% 
  filter(score == "species")
species_cca[3:8] <- species_cca[, 3:8] * 2.5 
species_cca$label <- c("Salix", "B. nana", "decid. dwarf shrubs", "J. communis", "evergr. dwarf shrubs", "graminoids", "forbs", "ferns", "bryophytes", "lichens", "bare ground", "rock")

meta_cca <- fortify(main_cca) %>% 
  filter(score == "sites") %>% 
  column_to_rownames("label") %>% 
  dplyr::select(!score)
  
meta_cca <- cbind(y, meta_cca)

# create convex hulls
hull_data <- meta_cca %>% # find convex hulls
  group_by(country) %>% # for each combination of country and habitat
  arrange(CCA1, CA1) %>%
  slice(chull(CCA1, CA1))

ggplot() + 
  geom_polygon(data = hull_data, aes(x = CCA1, y = CA1, fill = country, color = country), alpha = 0.30) + 
  geom_point(data = meta_cca, aes(x = CCA1, y = CA1, shape = habitat, colour = country), size = 3, alpha = 0.70) + # add the point markers
     scale_color_manual(values = c("#EB956A", "#77BFBC"), labels = c("High", "Low")) + 
  scale_fill_manual(values = c("#EB956A", "#77BFBC"), labels = c("High", "Low")) +
  geom_text(data = species_cca, aes(x = CCA1, y = CA1, label = label), size = 4,  alpha = 0.7) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
  labs(fill = "Reindeer density", color = "Reindeer density", shape = "Habitat") +
  theme_classic() +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))

ggsave("../../3_output/2_graphs/publication_ready/Fig4_cca.svg", height = 3.5, width = 7)
```

#### country * habitat
```{r}
main_cca <- cca(x ~ country * habitat, y)
permutest(main_cca, permutations = how(nperm = 999))
```

```{r}
# get CCA scores ready for plotting
species_cca <- fortify(main_cca) %>% 
  filter(score == "species")

meta_cca <- fortify(main_cca) %>% 
  filter(score == "sites") %>% 
  column_to_rownames("label") %>% 
  select(!score)
  
meta_cca <- cbind(y, meta_cca)

# create convex hulls
hull_data <- meta_cca %>% # find convex hulls
  group_by(country, habitat) %>% # for each combination of country and habitat
  arrange(CCA1, CCA2) %>%
  slice(chull(CCA1, CCA2))

ggplot() +   
  geom_point(data = meta_cca, aes(x = CCA1, y = CCA2, shape = habitat, colour = country), size = 3) + # add the point markers
  scale_color_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) + 
  geom_polygon(data = hull_data, aes(x = CCA1, y = CCA2, fill = country, color = country, linetype = habitat), alpha = 0.30, show.legend = TRUE) +
  scale_linetype_manual(name = "Habitat", labels = c("forest", "treeline", "tundra", "upper tundra"), 
    values = c("forest" = "solid", "treeline" = "dashed", "tundra" = "dotdash", "upper_tundra" = "dotted")) +
  scale_fill_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) +
  geom_text(data = species_cca,aes(x = CCA1, y = CCA2, label = label), alpha = 0.5) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
  labs(fill = "Grazing regime", color = "Grazing regime", shape = "Habitat") +
  theme_classic() +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  guides(linetype = "none") + # no weird linetype legend items
  guides(shape = guide_legend(override.aes = list(linetype = c("solid", "dashed", "dotdash", "dotted")))) + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), strip.background = element_rect(color = "black", size = 1)) 
```


#### full model select
```{r include = FALSE}
x <-  meta_data %>% 
  na.omit() %>% # removes data with missing values in the soil chemical composition variables
  select(salix:rock) 
  
y <- meta_data %>% 
  na.omit() %>% 
  select(country, habitat, dung_count:twi, NO3:CN_ratio)
```

```{r}
null_cca <-
  cca(x ~ 1, data = y) # model containing only species matrix and intercept

# The step wise selection, based on R2
sel_cca <-
  ordiR2step(
    null_cca,
    scope = formula (full_cca),
    R2scope = r2,
    direction = 'forward',
    permutations = 999
  )
sel_cca
```

```{r}
sel_cca_adj <- sel_cca # get adjusted p values from the anova 
sel_cca_adj$anova$`Pr(>F)` <- p.adjust(sel_cca$anova$`Pr(>F)`, method = 'holm', n = ncol(y)) 
sel_cca_adj$anova
```

```{r}
# get CCA scores ready for plotting
species_cca <- fortify(sel_cca) %>% 
  filter(score == "species")

meta_cca <- fortify(sel_cca) %>% 
  filter(score == "sites") %>% 
  column_to_rownames("label") %>% 
  select(!score)
  
meta_cca <- cbind(y, meta_cca)

# create convex hulls
hull_data <- meta_cca %>% # find convex hulls
  group_by(country) %>% # for each combination of country and habitat
  arrange(CCA1, CCA2) %>%
  slice(chull(CCA1, CCA2))

ggplot() + 
  geom_point(data = meta_cca, aes(x = CCA1, y = CCA2, shape = habitat, colour = country), size = 3) + # add the point markers
  scale_color_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) + 
  geom_polygon(data = hull_data, aes(x = CCA1, y = CCA2, fill = country, color = country),alpha=0.30) + 
  scale_fill_manual(values = c("#EB956A", "#77BFBC"), labels = c("Year-round", "Winter")) +
  geom_text(data = species_cca,aes(x = CCA1, y = CCA2, label = label), alpha = 0.5) +  # add the species labels
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  coord_equal() +
#  geom_segment(aes(x = 0, y = 0, xend = CCA1, yend = CCA2), 
#       data = ef_coord_cont, linewidth =1, alpha = 0.5, colour = #"grey30") +
#     geom_point(data = ef_coord_cat, aes(x = CCA1, y = CCA2), 
#       shape = "diamond", size = 4, alpha = 0.6, colour = "navy") +
#     geom_text(data = ef_coord_cat, aes(x = CCA1, y = CCA2+0.08), 
#       label = row.names(ef_coord_cat), colour = "navy", fontface = #"bold") + 
#     geom_text(data = ef_coord_cont, aes(x = CCA1, y = CCA2), colour = #"grey30", 
#       fontface = "bold", label = row.names(ef_coord_cont)) + 
  labs(fill = "Grazing regime", color = "Grazing regime", shape = "Habitat") +
  theme_classic() +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))
```

## Fig 5. chem 
### Mineralized nutrients
```{r}
dnp <- read_excel("../../2_input/1_raw_data/chem/DNP.xlsx") %>% 
  mutate(country = as.factor(ifelse(grepl('N', code), 'Storfjord', 'Malla')))
```

```{r}
dnp$country <- factor(dnp$country, levels = c("Storfjord", "Malla"))
```
#### Phosphate (PO4)
```{r phosphate boxplot, echo = FALSE}
p1 <- dnp %>% 
  na.omit() %>% 
  ggplot(aes(x = Habitat, y = PO4_corrected, fill = country)) + scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_boxplot() 
```

#### Ammonium (NH4)
```{r ammonium boxplot, echo = FALSE}
p2 <- dnp %>% 
  na.omit() %>% 
  ggplot(aes(x = Habitat, y = NH4, fill = country)) + scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_boxplot()
```

#### Nitrate (NO3)
```{r, echo = FALSE}
p3 <- dnp %>% 
  na.omit() %>% 
  ggplot(aes(x = Habitat, y = NO3, fill = country)) + scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_boxplot()
```

```{r}
ggarrange(p1, p2, p3, 
          ncol = 3,
          common.legend = TRUE)

ggsave("../../3_output/2_graphs/publication_ready/mineralized.svg",
       height = 4, width = 7)
```

### soil
```{r}
chem_data <- read.csv("../../2_input/1_raw_data/chem/chem_malla_soil_leaves.csv")
head(chem_data)

cn_soil <- chem_data %>% 
  filter(type == "soil") %>% 
  filter(comment != "broken capsule") %>% 
  mutate(transect_ID = paste(country, transect, sep = "")) %>% 
  dplyr::select(Sample_ID, country, transect, transect_ID, everything())

cn_leaf <- chem_data %>% 
  filter(type == "leaf") %>% 
  filter(comment != "broken capsule") %>% 
  mutate(transect_ID = paste(country, transect, sep = "")) %>% 
  dplyr::select(Sample_ID, country, transect, transect_ID, everything())
```


```{r}
cn_soil$country <- factor(cn_soil$country, levels = c("N", "F"))
```

#### % carbon
```{r soil carbpm boxplot, echo = FALSE}
p1 <- cn_soil %>% 
  ggplot(aes(y = wC, fill = country)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High")) +
  labs(fill = "Reindeer density", y = "ωC") +
  theme_classic()  +
  geom_boxplot() + 
  geom_text(aes(y = 48, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) +
  theme(axis.text.x = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1)) 
```

#### delta13C
```{r soil d13C boxplot, echo = FALSE}
p2 <- cn_soil %>% 
  ggplot(aes(fill = country, y = d13C)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "δ13C") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot() +
geom_text(aes(y = -26.2, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) 
```

#### % nitrogen
```{r soil nitrogen boxplot, echo = FALSE}
p3 <- cn_soil %>% 
  ggplot(aes(y = wN, fill = country)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "ωN") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot() +
geom_text(data = sig, aes(y = 2, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) 
```

#### delta15N
```{r soil d15N boxplot, echo = FALSE}
p4 <- cn_soil %>% 
  ggplot(aes(y = d15N, fill = country)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "δ15N") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot() +
geom_text(data = sig, aes(y = 3.5, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) 
```

```{r}
pa <- ggarrange(p1, p2, p3, p4, 
                #labels = c("a", "b", "c", "d"),
                ncol = 4, nrow = 1,
                common.legend = TRUE)

pa <- annotate_figure(pa, left = text_grob("Soil", rot = 90, face = "bold", hjust = 1.1)); print(pa)

#ggsave("../../3_output/2_graphs/publication_ready/soil_chem.svg",
#       height = 2, width = 4)
```

### leaves
```{r}
cn_leaf$country <- factor(cn_leaf$country, levels = c("N", "F"))
```

#### % carbon
```{r leaf carbon boxplot, echo = FALSE}
p1 <- cn_leaf %>% 
  ggplot(aes(fill = country, y = wC)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High")) +
  labs(fill = "Reindeer density", y = "ωC") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot(outliers = FALSE) +
geom_text(aes(y = 49.8, label = "**", x = 0), 
                  position = position_dodge(width = 0)) 
```

#### delta13C
```{r leaf d13C boxplot, echo = FALSE}
p2 <- cn_leaf %>% 
  ggplot(aes(fill = country, y = d13C)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "δ13C") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot() +
geom_text(aes(y = -29.6, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) 
```

#### % nitrogen
```{r leaf nitrogen boxplot, echo = FALSE}
p3 <- cn_leaf %>% 
  ggplot(aes(fill = country, y = wN)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "ωN") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot() +
geom_text(aes(y = 3.2, label = "ns", x = 0), 
                  position = position_dodge(width = 0)) 
```

#### delta15N
```{r leaf d15N boxplot, echo = FALSE}
p4 <- cn_leaf %>% 
  ggplot(aes(fill = country, y = d15N)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  labs(y = "δ15N") +
  theme_classic() +
  theme(axis.text.x=element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "none") +
  geom_boxplot(outliers = FALSE) +
geom_text(aes(y = 1, label = "*", x = 0), 
                  position = position_dodge(width = 0)) 
```

```{r}
pb <- ggarrange(p1, p2, p3, p4, 
                #labels = c("e", "f", "g", "h"),
                ncol = 4, nrow = 1)

pb <- annotate_figure(pb, left = text_grob("Leaves", rot = 90, face = "bold")); print(pb)

#ggsave("../../3_output/2_graphs/publication_ready/leaf_chem.svg",
#       height = 4, width = 4)
```

```{r}
ggarrange(pa, pb,
          nrow = 2,
          heights = c(1, 0.8))

ggsave("../../3_output/2_graphs/publication_ready/Fig5_soil_leaf_chem.svg",
       height = 4, width = 5.5)
```


# ESM
## reindeer numbers over time 
```{r}
x <- read.csv("../../2_input/1_raw_data/reindeer_numbers.csv") %>% 
  dplyr::select(Year, Bassevuovdi, Kasivarsi) %>% 
  pivot_longer(Bassevuovdi:Kasivarsi, names_to = "District", values_to = "n_KM2")
```

```{r}
ggplot(x, aes(x = Year, y = n_KM2, color = District)) +
  geom_line() +
  geom_point() + 
  labs(x = "Year", y = "# reindeer/km2") +
  scale_color_manual(values = c("#77BFBC", "#EB956A"), labels = c("Bassevuovdi (Norway)", "Käsivarsi (Finland)")) +
  theme_classic() + 
  theme(legend.position = c(0.8, 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

ggsave("../../3_output/2_graphs/publication_ready/FigSx_reindeer_numbers.svg",
       height = 4, width = 6)
```

## functional type covers
```{r echo = FALSE}
vegetation_data_l <- readr::read_csv('../../2_input/1_raw_data/vegetation_data_raw.csv') %>% 
  pivot_longer(salix:bareGr, names_to = "type", values_to = "cover")

vegetation_data_l %>% head(10)
```

```{r}
facet_order <- c("forb", "gram", "lich", "bry", "bareGr", "salix", "Bnana", "Jcomm", "dDwarf", "eDwarf")
type_labs <- c("Forbs", "Graminoids", "Lichens", "Bryophytes", "Bare ground", "Salix", "B. nana", "J. communis", "Evergr. dwarf shrubs", "Dedid. dwarf shrubs")
names(type_labs) <- c("forb", "gram", "lich", "bry", "bareGr", "salix", "Bnana", "Jcomm", "dDwarf", "eDwarf")

vegetation_data_l %>% 
  dplyr::filter(!type == "ferns") %>% # omit ferns 
  mutate(type = factor(type, levels = facet_order)) %>% # order of facets
  mutate(country = factor(country, levels = c("N", "F"))) %>% # order of bars
  ggplot(aes(x = habitat, y = cover, fill = country)) +
  geom_boxplot(outliers = FALSE) + 
  facet_wrap(~type, scales = "free_y", nrow = 2,
             labeller = labeller(type = type_labs)) +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Low", "High")) +
  labs(fill = "Reindeer density", x = "Habitat", y = "% Cover") +
  theme_classic() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        legend.position = "top", 
        axis.line=element_line(),
        axis.text.x = element_text(angle = 25, hjust = 1))
```


```{r}
ggsave("../../3_output/2_graphs/publication_ready/FigSx_type_covers.svg", height = 5, width = 7)
```

# Defunct

```{r}
vegetation_data %>% 
  na.omit() %>% 
  map(~ ggplot(aes(x = habitat, y = .x, fill = country)) +
  geom_boxplot())
```
## numbers of trees + dung counts
```{r include = FALSE}
# transect meta data
transect_data <- readr::read_csv('../../3_output/1_data_products/transect_data.csv')

transect_data <- readr::read_csv('../../3_output/1_data_products/dung_data_transect_summary.csv') %>% 
  #select(!frequency) %>% 
  rename(habitat = section) %>% 
  full_join(transect_data)
transect_data %>% head(10)
```

```{r echo = FALSE}
tree_transect_data_full <- readr::read_csv('../../3_output/1_data_products/tree_transect_data_full.csv')
tree_transect_data_full %>% head(10)

tree_transect_data_full <- tree_transect_data_full %>% 
  left_join(transect_data, by = c("transect" = "transect", "country" = "country", "section" = "habitat"))
```


```{r boxplot of numbers of trees per class,echo = FALSE}
facet_order <- c("seedling", "sapling", "tree", "dead")

tree_transect_data_full$country <- factor(tree_transect_data_full$country, levels = c("Storfjord", "Malla"))

tree_transect_data_full$class <- factor(tree_transect_data_full$class, levels = c("seedling", "sapling", "tree", "dead"))

# create label information for significance 
sig <- distinct(tree_transect_data_full, class, section, country) %>%
  arrange(class, section, country) 

#sig$y = c(20, 0, 6, 0, 5, 0, 40, 0, 24, 0, 14, 0, 16, 0, 42, 0, 20, 0, 50, 0, 9, 0, 12, 0)

sig$y = c(16, 0, 42, 0, 20, 0, 40, 0, 24, 0, 14, 0, 50, 0, 9, 0, 12, 0, 20, 0, 6, 0, 5, 0)

#sig$label = c("*", NA, "ns", NA, "ns", NA, "***", NA, "***", NA, "**", NA,"ns", NA, "ns", NA, "*", NA, "ns", NA, "ns", NA, "**", NA)

sig$label = c("*", NA, "ns", NA, "ns", NA, "***", NA, "***", NA, "**", NA,"ns", NA, "ns", NA, "**", NA, "*", NA, "ns", NA, "ns", NA)

#data.frame(
#  class = c("seedling", "sapling", "tree", "dead"), 
#  section = c("forest", "treeline", "tundra"),
#  start = rep("D. f", 3),
#  end = rep("D. p", 3),
#  y = rep(1.05, 3),
#  label = c("+", "+", "+")
#) %>%
#mutate(Behaviour = fct_relevel(class,
#                                 "seedling", "sapling", "tree", "dead")); signif2

p1 <- tree_transect_data_full %>%
  mutate(class = factor(class, levels = facet_order)) %>% 
  #filter(class != "dead" & class != "tree") %>%  
  ggplot(aes(section, n, fill = country)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(), alpha = 0.3, position = position_jitterdodge(jitter.width = 0, dodge.width = 0.75)) + 
  geom_text(data = sig, aes(y = y, label = label), 
                  position = position_dodge(width = 0)) +
  theme_classic() +
  facet_grid(~class, scales = "free", drop = TRUE) + 
  labs(fill = "Grazing regime", x = "Habitat", y = "Count") +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round")) +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        axis.text.x = element_text(angle = 45, hjust = 1)); print(p1)
```

```{r echo = FALSE}
dung_transect_data <- readr::read_csv('../../2_input/2_data_products/dung_data_transect_summary.csv')

dung_transect_data <- dung_transect_data %>% 
  mutate(country = as.factor(ifelse(grepl('N', transect), 'Storfjord', 'Malla'))) %>%
  dplyr::select(transect, country, everything())

dung_transect_data %>% head(10)
```

```{r echo = FALSE}
dung_transect_data$country <- factor(dung_transect_data$country, levels = c("Storfjord", "Malla"))

# create label information for significance 
sig <- distinct(dung_transect_data, section, country) %>% 
  arrange(section, country) 

sig$y = c(39, 0, 45, 0, 44, 0)
sig$label = c("***", NA, "***", NA, "***", NA)


p2 <- dung_transect_data %>%
  ggplot(aes(section, frequency, fill = country)) + 
  geom_boxplot() + 
  geom_jitter(aes(), alpha = 0.3, position = position_jitterdodge(jitter.width = 0, dodge.width = 0.75)) +
  geom_text(data = sig, aes(y = y, label = label), 
                  position = position_dodge(width = 0)) +
  theme_classic() +
  labs(fill = "Grazing regime", x = "Habitat", y = "Dung count") +
  scale_fill_manual(values = c("#77BFBC", "#EB956A"), labels = c("Winter", "Year-round"), guide = "none") +
  theme(panel.spacing = unit(.0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        axis.text.x = element_text(angle = 45, hjust = 1), 
        ); print(p2)


```

```{r}
ggarrange(p2, p1, 
          ncol = 2, 
          labels = c("a", "b"), 
          widths = c(.5, 2))

ggsave("../../3_output/2_graphs/publication_ready/tree_dung_counts2.svg",
       height = 4, width = 7)
```


